---

- name: Ensure swapon unit is present
  template: src=templates/swapon.service dest=/etc/systemd/system owner=core group=core

- name: Ensure cleanup unit is present
  template: src=templates/cleanup.service dest=/etc/systemd/system owner=core group=core

- name: Ensure puma unit is present
  template: src=templates/ghntfr-puma@.service dest=/etc/systemd/system/ghntfr-puma-{{ app.env }}@.service owner=core group=core

- name: Ensure puma discovery unit is present
  template: src=templates/ghntfr-puma-discovery@.service dest=/etc/systemd/system/ghntfr-puma-discovery-{{ app.env }}@.service owner=core group=core

- name: Ensure sidekiq unit is present
  template: src=templates/ghntfr-sidekiq.service dest=/etc/systemd/system/ghntfr-sidekiq-{{ app.env }}.service owner=core group=core

- name: Ensure enqueuer unit is present
  template: src=templates/ghntfr-enqueuer.service dest=/etc/systemd/system/ghntfr-enqueuer-{{ app.env }}.service owner=core group=core

- name: Ensure vulcand unit is present
  template: src=templates/vulcand@.service dest=/etc/systemd/system owner=core group=core

- name: Ensure newrelic unit is present
  template: src=templates/newrelic-nrsysmond.service dest=/etc/systemd/system owner=core group=core

- name: Ensure rebalance service unit is present
  template: src=templates/rebalance.service dest=/etc/systemd/system owner=core group=core

- name: Ensure check uptime service unit is present
  template: src=templates/check-uptime.service dest=/etc/systemd/system owner=core group=core

- name: Ensure rolling restart script is present
  template: src=templates/rolling-restart.sh dest=/home/core/rolling-restart.sh owner=core group=core mode=0775

- name: Ensure rolling rebuild script is present
  template: src=templates/rolling-rebuild.sh dest=/home/core/rolling-rebuild.sh owner=core group=core mode=0775

- name: Ensure deployment script is present
  template: src=templates/ghntfr-deploy.sh dest=/home/core/ghntfr-deploy.sh owner=core group=core mode=0775

- name: Ensure rebalance services script is present
  template: src=templates/rebalance-services.sh dest=/home/core/rebalance-services.sh owner=core group=core mode=0775

- name: Ensure cloudflare management scripts are present
  template: src=templates/{{ item }} dest=/home/core/{{ item }} owner=core group=core mode=0775
  with_items:
    - cf-record-add.sh
    - cf-record-del.sh
    - check-uptime.sh

- name: Ensure cfcli is present
  git: repo=https://github.com/danielpigott/cloudflare-cli.git dest=/home/core/cfcli version=52e4661aa92d3b5ffae221fddd9f0c446f1d192b update=no

- name: Run npm install
  shell: docker run -it --rm --name cfcli -v "$PWD":/usr/src/myapp -w /usr/src/myapp node:4 npm install chdir=/home/core/cfcli creates=/home/core/cfcli/node_modules/

- name: Ensure cfcli configuration is in place
  template: src=templates/cfcli.yaml dest=/home/core/cfcli/.cfcli.yaml owner=core group=core mode=0600
